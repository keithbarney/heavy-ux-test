#!/usr/bin/env node

import { run } from './src/runner.mjs';

const args = process.argv.slice(2);
const opts = {
  target: null,
  mode: 'all',
  flowName: null,
  all: false,
  headed: false,
  scanDirs: [],
  updateBaselines: false,
  noVisual: false,
  breakpoints: null,
};

for (let i = 0; i < args.length; i++) {
  switch (args[i]) {
    case '--smoke':
      opts.mode = 'smoke';
      break;
    case '--flows':
      opts.mode = 'flows';
      break;
    case '--flow':
      opts.mode = 'flows';
      opts.flowName = args[++i];
      break;
    case '--all':
      opts.all = true;
      break;
    case '--scan-dir':
      opts.scanDirs.push(args[++i]);
      break;
    case '--headed':
      opts.headed = true;
      break;
    case '--update-baselines':
      opts.updateBaselines = true;
      break;
    case '--no-visual':
      opts.noVisual = true;
      break;
    case '--breakpoints':
      opts.breakpoints = args[++i].split(',').map(Number);
      break;
    case '--help':
    case '-h':
      console.log(`
heavy-ux-test â€” Automated UX smoke & flow testing

Usage:
  ux-test                        Run in current directory
  ux-test <path>                 Target a specific project
  ux-test --smoke                Smoke tests only
  ux-test --flows                Flow tests only
  ux-test --flow "Flow name"     Single named flow
  ux-test --all                  Test all projects with .ux-test.json
  ux-test --scan-dir <path>      Directory to scan (repeatable, use with --all)
  ux-test --headed               Show browser window
  ux-test --update-baselines     Accept current screenshots as new baselines
  ux-test --no-visual            Take breakpoint screenshots but skip comparison
  ux-test --breakpoints 375,768  Override breakpoints for this run

Config:
  ~/.ux-test.json                Global config (scanDirs for --all default)
  <project>/.ux-test.json        Per-project test config
`);
      process.exit(0);
    default:
      if (!args[i].startsWith('-')) {
        opts.target = args[i];
      }
      break;
  }
}

const passed = await run(opts);
process.exit(passed ? 0 : 1);
